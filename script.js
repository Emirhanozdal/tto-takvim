document.addEventListener("DOMContentLoaded",(()=>{let e=document.getElementById("year-view"),t=document.getElementById("month-view"),n=document.getElementById("user-panel"),l=document.getElementById("year-str"),a=document.getElementById("year-view-body"),s=document.getElementById("month-year-str"),i=document.getElementById("calendar-grid-container"),d=document.getElementById("entry-modal"),o=document.getElementById("manage-modal"),r=document.getElementById("details-modal");let c=new Date,m=c.getFullYear(),p=JSON.parse(localStorage.getItem("tto_takvim_entries"))||{},u=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],h=["Pzt","Sal","Çar","Per","Cum","Cmt","Paz"];let g=!1;const E=e=>{g=!!e,document.body.classList.toggle("admin-mode",g),e?(n.innerHTML=`<span>${e.email}</span><button id="logout-btn">Çıkış Yap</button>`,document.getElementById("logout-btn").addEventListener("click",()=>window.netlifyIdentity.logout())):(n.innerHTML="",window.netlifyIdentity.open(),window.netlifyIdentity.close()),y(),t.classList.contains("hidden")||f()};window.netlifyIdentity&&(window.netlifyIdentity.on("init",e=>E(e)),window.netlifyIdentity.on("login",e=>{E(e)}),window.netlifyIdentity.on("logout",()=>E(null)));const y=()=>{l.textContent=m,a.innerHTML="";for(let e=0;e<12;e++){let t=document.createElement("div");t.className="mini-calendar",t.addEventListener("click",()=>{c=new Date(m,e,1),w()});let n=document.createElement("div");n.className="mini-calendar-header",n.textContent=u[e];let s=document.createElement("div");s.className="mini-day-names",h.forEach(e=>s.innerHTML+=`<div>${e}</div>`);let i=document.createElement("div");i.className="mini-day-grid";let d=new Date(m,e,1),o=new Date(m,e+1,0).getDate(),r=0===d.getDay()?6:d.getDay()-1;for(let e=0;e<r;e++)i.innerHTML+='<div class="mini-day"></div>';for(let t=1;t<=o;t++){let n=document.createElement("div");n.className="mini-day",n.textContent=t;let l=`${m}-${String(e+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`;p[l]&&n.classList.add("has-event");let a=`${m}-${String(e+1).padStart(2,"0")}`;p[a]?.some(e=>"project"===e.type)&&n.classList.add("is-project");let s=new Date;t===s.getDate()&&e===s.getMonth()&&m===s.getFullYear()&&n.classList.add("is-today"),i.appendChild(n)}t.append(n,s,i),a.appendChild(t)}},f=()=>{i.innerHTML="";let e=c.getFullYear(),t=c.getMonth();s.textContent=`${u[t]} ${e}`;let n=`${e}-${String(t+1).padStart(2,"0")}`,l=p[n]?.filter(e=>"project"===e.type)||[],a=l.length>0;document.getElementById("manage-projects-btn").classList.toggle("hidden",!(g&&a)),h.forEach(e=>{let t=document.createElement("div");t.className="day-name",t.textContent=e,i.appendChild(t)});let d=new Date(e,t,1),o=0===d.getDay()?7:d.getDay(),r=new Date(d);r.setDate(r.getDate()-(o-1));for(let l=0;l<42;l++){let n=new Date(r);n.setDate(r.getDate()+l);let s=document.createElement("div");s.classList.add("day");let h=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`;n.getMonth()!==t?s.classList.add("prev-next-month-day"):a&&s.classList.add("project-month-day");let E=new Date;n.getDate()===E.getDate()&&n.getMonth()===E.getMonth()&&n.getFullYear()===E.getFullYear()&&s.classList.add("today"),s.innerHTML=`<div class="day-number">${n.getDate()}</div>`;let y=p[h]?.some(e=>"event"===e.type);y&&(s.innerHTML+='<div class="event-list-day">'+p[h].filter(e=>"event"===e.type).map(e=>`<div class="event-item-day">${e.title}</div>`).join("")+"</div>"),g&&(y&&(s.classList.add("clickable"),s.addEventListener("click",()=>b(h))),n.getMonth()===t&&(s.innerHTML+=`<button class="add-day-btn" data-date="${h}">+</button>`)),i.appendChild(s)}},b=e=>{let t=p[e]?.find(e=>"event"===e.type);if(!t)return;let n=new Date(e+"T00:00:00"),l=`${n.getDate()} ${u[n.getMonth()]} ${n.getFullYear()}`;document.getElementById("details-title").textContent=t.title,document.getElementById("details-date").textContent=l;let a=document.getElementById("details-media-container");if(a.innerHTML="",t.imageUrl){if(t.imageUrl.includes("instagram.com")){let e=document.createElement("blockquote");e.className="instagram-media",e.setAttribute("data-instgrm-captioned",""),e.setAttribute("data-instgrm-permalink",t.imageUrl);let n=document.createElement("script");n.async=!0,n.src="//www.instagram.com/embed.js",e.appendChild(n),a.appendChild(e),setTimeout(()=>window.instgrm.Embeds.process(),100)}else a.innerHTML=`<img src="${t.imageUrl}" alt="Etkinlik Görseli">`;a.classList.remove("hidden")}else a.classList.add("hidden");document.getElementById("manage-event-btn").onclick=()=>{r.style.display="none",v(e)},r.style.display="flex"},v=e=>{let t=e.length===7,n=t?"project":"event";document.getElementById("manage-modal-title").textContent=`${"event"===n?"Etkinlikleri":"Projeleri"} Yönet`;let l=document.getElementById("manage-modal-date");t?l.textContent="":l.textContent=((e,t)=>{let n=new Date(e+"T00:00:00");return`${n.getDate()} ${t[n.getMonth()]} ${n.getFullYear()}`})(e,u);let a=document.getElementById("entry-list");a.innerHTML="";let s=p[e]?.filter(t=>t.type===n)||[];s.length===0?a.innerHTML="<li>Silinecek kayıt bulunmuyor.</li>":s.forEach((t,n)=>{let s=document.createElement("li");s.innerHTML=`<span>${t.title}</span><button class="delete-btn" data-key="${e}" data-index="${n}">Sil</button>`,a.appendChild(s)}),o.style.display="flex"},k=e=>{let t=e.querySelector(".close-btn");t.addEventListener("click",()=>e.style.display="none"),e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")})};[d,o,r].forEach(k);const L=e=>{let t=document.getElementById("entry-modal");t.querySelector("form").reset(),C(),document.getElementById("type-event").checked=!0,document.getElementById("event-date-input").value=e,C(),t.style.display="flex"};document.getElementById("entry-list").addEventListener("click",e=>{if(e.target.classList.contains("delete-btn")){let t=e.target.dataset.key,n=parseInt(e.target.dataset.index),l=t.length===7?"project":"event",a=0,s=-1;for(let e=0;e<p[t].length;e++)if(p[t][e].type===l){if(a===n){s=e;break}a++}s!==-1&&(p[t].splice(s,1),0===p[t].length&&delete p[t],localStorage.setItem("tto_takvim_entries",JSON.stringify(p)),f(),o.style.display="none")}});const C=()=>{let e=document.getElementById("type-event").checked;document.getElementById("event-inputs").classList.toggle("hidden",!e),document.getElementById("project-inputs").classList.toggle("hidden",e),document.getElementById("event-title-input").required=e,document.getElementById("event-date-input").required=e,document.getElementById("project-title-input").required=!e,document.getElementById("project-month-input").required=!e};document.getElementById("entry-form").addEventListener("submit",e=>{e.preventDefault();let t=document.querySelector('input[name="entry-type"]:checked').value,n,l;if("event"===t){let e=document.getElementById("event-title-input").value.trim(),t=document.getElementById("event-date-input").value,a=document.getElementById("event-image-input").value.trim();if(!e||!t)return;n=t,l={type:"event",title:e,imageUrl:a}}else{let e=document.getElementById("project-title-input").value.trim(),t=document.getElementById("project-month-input").value;if(!e||!t)return;n=t,l={type:"project",title:e}}p[n]||(p[n]=[]),p[n].push(l),localStorage.setItem("tto_takvim_entries",JSON.stringify(p)),t.classList.contains("hidden")?y():f(),d.style.display="none"});const w=()=>{e.classList.add("hidden"),t.classList.remove("hidden"),f()};document.getElementById("prev-year-btn").addEventListener("click",()=>{m--,y()}),document.getElementById("next-year-btn").addEventListener("click",()=>{m++,y()}),document.getElementById("prev-month-btn").addEventListener("click",()=>{c.setMonth(c.getMonth()-1),f()}),document.getElementById("next-month-btn").addEventListener("click",()=>{c.setMonth(c.getMonth()+1),f()}),document.getElementById("today-btn").addEventListener("click",()=>{c=new Date,w()}),document.getElementById("back-to-year-view-btn").addEventListener("click",showYearView),document.querySelectorAll('input[name="entry-type"]').forEach(e=>e.addEventListener("change",C)),document.getElementById("manage-projects-btn").addEventListener("click",()=>{let e=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;v(e)}),document.getElementById("calendar-grid-container").addEventListener("click",e=>{e.target.classList.contains("add-day-btn")&&L(e.target.dataset.date)}),y()}));
